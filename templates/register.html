<!-- templates/register.html -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - MONA</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        height: 100vh;
        background-color: #e8f6fb;
        background-repeat: no-repeat;
        background-position: left center;
        background-size: contain;
        display: flex;
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
      }
      .register-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .logo-header {
        width: 350px;
        margin-bottom: 20px;
        cursor: pointer;
      }
      .logo-header img {
        width: 100%;
        display: block;
      }
      .form-container {
        width: 350px;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        justify-content: center;
        align-items: center;
      }
      .form-container h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .form-container input {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .form-container button {
        background-color: #4a90e2;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
      }
      .form-container button:hover {
        background-color: #357abd;
      }
      .form-container p {
        margin-top: 8px;
        font-size: 13px;
      }
      .check-button {
        width: 70px;
        height: 40px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 10px;
        white-space: pre-line;
        padding: 2px;
        margin-left: 5px;
      }
      .submit-button {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="register-wrapper">
        <div class="logo-header" @click="goToLogin">
          <img src="/static/_mona_logo.png" alt="MONA ë¡œê³ " />
        </div>
        <div class="form-container">
          <h2>íšŒì›ê°€ì…</h2>
          <form @submit.prevent="register">
            <div style="display: flex; width: 100%; align-items: center">
              <input
                type="text"
                v-model="username"
                placeholder="ì•„ì´ë””"
                required
                style="flex: 1"
              />
              <button class="check-button" type="button" @click="checkUsername">
                ì¤‘ë³µí™•ì¸
              </button>
            </div>
            <p
              v-if="usernameMessage"
              :style="{ color: usernameAvailable ? 'green' : 'red' }"
            >
              {{ usernameMessage }}
            </p>

            <input
              type="text"
              v-model="nickname"
              placeholder="ë‹‰ë„¤ì„"
              required
            />
            <input
              type="password"
              v-model="password"
              placeholder="ë¹„ë°€ë²ˆí˜¸"
              required
            />
            <p
              v-if="password.length > 0 && password.length < 8"
              style="color: red"
            >
              ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤
            </p>

            <input
              type="password"
              v-model="confirmPassword"
              placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
              required
            />
            <p
              v-if="confirmPassword && password !== confirmPassword"
              style="color: red"
            >
              ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
            </p>

            <button class="submit-button" type="submit">ê°€ì…í•˜ê¸°</button>
          </form>
          <p v-if="message" :style="{ color: success ? 'green' : 'red' }">
            {{ message }}
          </p>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            username: '',
            nickname: '',
            password: '',
            confirmPassword: '',
            usernameAvailable: false,
            usernameMessage: '',
            message: '',
            success: false,
            lastCheckedUsername: '',
          };
        },
        methods: {
          async checkUsername() {
            if (!this.username) return;
            try {
              const res = await fetch(
                `/check-username?username=${encodeURIComponent(this.username)}`
              );
              const data = await res.json();
              this.usernameAvailable = !data.exists;
              this.usernameMessage = this.usernameAvailable
                ? 'âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!'
                : 'âŒ ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
              if (this.usernameAvailable) {
                this.lastCheckedUsername = this.username;
              }
              alert(this.usernameMessage);
            } catch {
              this.usernameAvailable = false;
              this.usernameMessage = 'âŒ ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤';
              alert(this.usernameMessage);
            }
          },
          async register() {
            if (this.password.length < 8) {
              this.success = false;
              this.message = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤';
              return;
            }
            if (this.password !== this.confirmPassword) {
              this.success = false;
              this.message = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
              return;
            }
            if (
              !this.usernameAvailable ||
              this.username !== this.lastCheckedUsername
            ) {
              this.success = false;
              this.message = 'ì•„ì´ë”” ì¤‘ë³µ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
              alert(this.message);
              return;
            }
            try {
              const res = await fetch('/register', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  username: this.username,
                  nickname: this.nickname,
                  password: this.password,
                }),
              });

              if (res.ok) {
                const data = await res.json();
                this.success = true;
                this.message = `ğŸ‰ ${data.nickname}ë‹˜, íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;
                setTimeout(() => {
                  if (
                    confirm(
                      this.message + '\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
                    )
                  ) {
                    window.location.href = '/login';
                  }
                }, 100);
              } else {
                let errorMessage = 'ê°€ì… ì‹¤íŒ¨';
                try {
                  const errorData = await res.json();
                  errorMessage = errorData.detail || errorMessage;
                } catch (e) {
                  console.warn('ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:', e);
                }
                this.success = false;
                this.message = errorMessage;
                alert(this.message);
              }
            } catch (err) {
              this.success = false;
              this.message = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
              alert(this.message);
            }
          },
          goToLogin() {
            window.location.href = '/login';
          },
        },
      }).mount('#app');
    </script>
  </body>
</html>
